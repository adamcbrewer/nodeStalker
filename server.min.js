var http=require("http"),https=require("https"),fs=require("fs"),express=require("express"),handlebars=require("handlebars"),os=require("os"),config=require(__dirname+"/config.js"),Client=require(__dirname+"/models/client.js"),server=express(),serverInst=http.createServer(server),io=require("socket.io").listen(serverInst),Server={clients:[],init:function(e){e=e||{};this.stalkSystem(2e3)},createClient:function(e){this.clients.push(e);console.log("-- LOG: The connected clients are: "+this.clients.length);this.broadcast({message:"hello you!"},e,!0)},destroyClient:function(e){var t=this;this.clients.forEach(function(n,r){if(e===n._key){t.clients.splice(r,1);console.log("-- LOG: The connected clients are: "+t.clients.length);return}console.log("-- LOG: Couldn't find client with id: "+e)})},broadcast:function(e,t,n){n=n||!1;e=e||{};t=t||this.clients[0]||!1;if(t){if(n){var r=e.client||e.all;t.socket.emit("broadcast",{results:e})}t.socket.broadcast.emit("broadcast",{results:e})}},stalkFile:function(e){e=e||!1;var t=e.interval||1e4;fs.watchFile(e.path,{interval:t},function(t,n){console.log("the current mtime is: "+t.mtime);console.log("the previous mtime was: "+n.mtime);fs.readFile(e.path,"utf8",function(e,t){if(e)throw e;console.log(t)})})},stalkFiles:function(e){var t=e.files||[],n=this,r=0;for(r;r<t.length;r++)this.stalkFile(t[r])},stalkSystem:function(e){var t=this;this.os={hostname:os.hostname(),type:os.type(),platform:os.platform(),uptime:os.uptime(),loadavg:os.loadavg(),totalmem:os.totalmem(),freemem:os.freemem(),cpus:os.cpus(),network:os.networkInterfaces()};setInterval(function(){t.updateSystem()},e)},updateSystem:function(e){var t=os.uptime(),n=os.loadavg(),r=os.totalmem(),i=os.freemem(),s=os.cpus();this.os.uptime=t;this.os.loadavg=n;this.os.totalmem=r;this.os.freemem=i;this.os.cpus=s;this.broadcast({osData:this.os},!1,!0)},loadTemplate:function(e){var t=fs.readFileSync(__dirname+"/view/"+e,"utf8",function(e,t){if(e)throw e;return t});return t}};serverInst.listen(config.serverPort);var publicDir=__dirname+"/public",assetsDir=publicDir+"/assets";server.use("/assets",express.static(assetsDir));Server.init({files:config.stalkingFiles});server.get("/*",function(e,t){var n=Server.loadTemplate("layout.tmpl"),r=handlebars.compile(n),i=r({basePath:config.basePath,siteurl:config.basePath+":"+config.serverPort});t.send(i)});io.sockets.on("connection",function(e){console.log("-- LOG: New client connection - "+e.id);Server.createClient(new Client({socket:e}));e.on("disconnect",function(){Server.destroyClient(e.id)})});